# Managed with ansible - Anubis reverse proxy integration
# https://anubis.techaro.lol/docs/admin/environments/apache/
#
# Anubis sits between Apache and the Madek webapp, filtering bot traffic.
# Service-specific paths (/admin, /api, /api-v2, /auth) are proxied directly
# by their own conf files at priority 800, bypassing Anubis.


###############################################################################
### Anubis required headers ###################################################
###############################################################################

# Anubis needs the real client IP and HTTP version
RequestHeader set "X-Real-Ip" expr=%{REMOTE_ADDR}
RequestHeader set "X-Http-Version" "%{SERVER_PROTOCOL}s"

# Preserve the original Host header for Anubis
ProxyPreserveHost On


###############################################################################
### Anubis own assets #########################################################
###############################################################################

# Anubis serves its challenge page assets from this path
ProxyPass /.within.website/ http://127.0.0.1:{{ anubis_port }}/.within.website/ nocanon retry=1
ProxyPassReverse /.within.website/ http://127.0.0.1:{{ anubis_port }}/.within.website/


###############################################################################
### Static asset exclusions ###################################################
###############################################################################

# Don't proxy static webapp assets through Anubis - serve directly via Apache
ProxyPass /assets !


###############################################################################
### Anubis catch-all proxy ####################################################
###############################################################################

# All remaining requests go through Anubis for bot filtering.
# Anubis will forward verified requests to the Madek webapp.
# This must come AFTER the service-specific confs (800) and BEFORE
# the webapp catch-all (900).
ProxyPassMatch ^/(.*)$ http://127.0.0.1:{{ anubis_port }}/$1 nocanon retry=1
ProxyPassReverse / http://127.0.0.1:{{ anubis_port }}/


# vim: syntax=apache
