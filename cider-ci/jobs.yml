build:
  run_when:
    integration tests passed:
      type: job
      job_key: integration-tests
      states: [passed]

  name: Build the deployment archive
  context:
    tasks:
      build:
        tree_attachments:
          archive:
            content_type: application/gzip
            include_match: ^madek\.tar\.gz$
          signature:
            content_type: application/octet-stream
            include_match: ^madek\.tar\.gz\.sig$
        git_options:
          submodules:
            include_match: ^.*$
        traits:
          Leiningen: yes
          git-crypt: yes
          madek-repo-decryption: yes
        scripts:
          unlock:
            body: |
              git crypt unlock
              git submodule foreach 'git crypt unlock || exit 0'
          build:
            start_when:
              unlocked:
                script_key: unlock
            timeout: 10 Minutes
            body: |
              set -eux
              cd deploy
              ./bin/archive-build
              ./bin/archive-sign
              cp madek.tar.gz* ../.


###############################################################################

'deploy_hslu':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to hslu
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "hslu.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/hslu

###############################################################################

'deploy_preview':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to preview
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "preview.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/preview

###############################################################################

'deploy_test8':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to test8
  run_when: &RUN_ON_MASTER
    master branch:
      type: branch
      include_match: ^master$
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "test8.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/test8



'deploy_test8_with-db-drop':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to test8 with drop-database
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "test8.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/test8
          DROP_DATABASE: 'true'

###############################################################################

'deploy_medienarchive':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to medienarchiv
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "medienarchiv.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/medienarchiv
        scripts:
          check-head-of-release:
            body: |
              set -eux
              git fetch --all
              [[ $(git log -n 1 --pretty=%H HEAD -- ) == $(git log -n 1 --pretty=%H origin/release -- ) ]]
          deploy:
            start_when:
              only when we are on the head of release:
                script_key: check-head-of-release
