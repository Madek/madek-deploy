build:
  run-on:

  - type: branch
    include-match: ^.*master.*$


  name: Build the deployment archive
  context:
    tasks:
      build:
        tree-attachments:
          archive:
            content-type: application/gzip
            include-match: ^madek\.tar\.gz$
          signature:
            content-type: application/octet-stream
            include-match: ^madek\.tar\.gz\.sig$
        git-options:
          submodules:
            clone: true
            timeout: 60
        traits:
          madek-cislave: true
        scripts:
          build:
            timeout: 10 Minutes
            body: |
              set -eux
              cd deploy
              ./bin/archive-build
              ./bin/archive-sign
              cp madek.tar.gz* ../.



###############################################################################

'deploy_hslu':
  _cider-ci_include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to hslu
  depends-on:
    - type: job
      job: build
      submodule: ['webapp']
      states: [passed]
  context:
    tasks:
      deploy:
        exclusive-global-resources:
          "hslu.madek.zhdk.ch": true
        environment-variables:
          HOSTS_FILE: inventories/zhdk/hslu

###############################################################################

'deploy_preview':
  _cider-ci_include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to preview
  depends-on:
    - type: job
      job: build
      submodule: ['webapp']
      states: [passed]
  context:
    tasks:
      deploy:
        exclusive-global-resources:
          "preview.madek.zhdk.ch": true
        environment-variables:
          HOSTS_FILE: inventories/zhdk/preview

'deploy_preview_with-restore-data':
  _cider-ci_include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to preview with restore-data
  depends-on:
    - type: job
      job: build
      submodule: ['webapp']
      states: [passed]
  context:
    tasks:
      deploy:
        exclusive-global-resources:
          "preview.madek.zhdk.ch": true
        environment-variables:
          HOSTS_FILE: inventories/zhdk/preview
          RESTORE_DATA: 'true'


###############################################################################


'deploy_test8':
  _cider-ci_include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to test8
  run-on:
  - type: branch
    include-match: ^master$
  depends-on:
    - type: job
      job: build
      submodule: ['webapp']
      states: [passed]
  context:
    tasks:
      deploy:
        exclusive-global-resources:
          "test8.madek.zhdk.ch": true
        environment-variables:
          HOSTS_FILE: inventories/zhdk/test8

'deploy_test8_with-db-drop':
  _cider-ci_include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to test8 with drop-database
  depends-on:
    - type: job
      job: build
      submodule: ['webapp']
      states: [passed]
  context:
    tasks:
      deploy:
        exclusive-global-resources:
          "test8.madek.zhdk.ch": true
        environment-variables:
          HOSTS_FILE: inventories/zhdk/test8
          DROP_DATABASE: 'true'

###############################################################################


'deploy_test':
  _cider-ci_include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to test
  run-on:
  - type: branch
    include-match: ^master$
  depends-on:
    - type: job
      job: build
      submodule: ['webapp']
      states: [passed]
  context:
    tasks:
      deploy:
        exclusive-global-resources:
          "test.madek.zhdk.ch": true
        environment-variables:
          HOSTS_FILE: inventories/zhdk/test

'deploy_test_with-restore-data':
  _cider-ci_include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to test with restore-data
  depends-on:
    - type: job
      job: build
      submodule: ['webapp']
      states: [passed]
  context:
    tasks:
      deploy:
        exclusive-global-resources:
          "test.madek.zhdk.ch": true
        environment-variables:
          HOSTS_FILE: inventories/zhdk/test
          RESTORE_DATA: 'true'

###############################################################################

'deploy_staging-v3-pdata':
  _cider-ci_include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to staging-v3-pdata
  depends-on:
    - type: job
      job: build
      submodule: ['webapp']
      states: [passed]
  context:
    tasks:
      deploy:
        exclusive-global-resources:
          "staging-v3-pdata.madek.zhdk.ch": true
        environment-variables:
          HOSTS_FILE: inventories/zhdk/staging-v3-pdata

'deploy_staging-v3-pdata_with-restore-data':
  _cider-ci_include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to staging-v3-pdata with restore-data
  depends-on:
    - type: job
      job: build
      submodule: ['webapp']
      states: [passed]
  context:
    tasks:
      deploy:
        exclusive-global-resources:
          "staging-v3-pdata.madek.zhdk.ch": true
        environment-variables:
          HOSTS_FILE: inventories/zhdk/staging-v3-pdata
          RESTORE_DATA: 'true'

###############################################################################

'deploy_staging-v3-upload':
  _cider-ci_include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to staging-v3-upload
  depends-on:
    - type: job
      job: build
      submodule: ['webapp']
      states: [passed]
  context:
    tasks:
      deploy:
        exclusive-global-resources:
          "staging-v3-upload.madek.zhdk.ch": true
        environment-variables:
          HOSTS_FILE: inventories/zhdk/staging-v3-upload

'deploy_staging-v3-upload_with-db-drop':
  _cider-ci_include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to staging-v3-upload with drop-database
  depends-on:
    - type: job
      job: build
      submodule: ['webapp']
      states: [passed]
  context:
    tasks:
      deploy:
        exclusive-global-resources:
          "staging-v3-upload.madek.zhdk.ch": true
        environment-variables:
          HOSTS_FILE: inventories/zhdk/staging-v3-upload
          DROP_DATABASE: 'true'
