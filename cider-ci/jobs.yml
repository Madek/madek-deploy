build:
  run_when:
    integration tests passed:
      type: job
      job_key: integration-tests
      states: [passed]

  name: Build the deployment archive
  context:
    tasks:
      build:
        tree_attachments:
          archive:
            content_type: application/gzip
            include_match: ^madek\.tar\.gz$
          signature:
            content_type: application/octet-stream
            include_match: ^madek\.tar\.gz\.sig$
        git_options:
          submodules:
            include_match: ^.*$
        traits:
          ci-executor-madek: yes
        scripts:
          build:
            timeout: 10 Minutes
            body: |
              set -eux
              cd deploy
              ./bin/archive-build
              ./bin/archive-sign
              cp madek.tar.gz* ../.


###############################################################################

'deploy_hslu':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to hslu
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "hslu.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/hslu

###############################################################################

'deploy_preview':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to preview
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "preview.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/preview

'deploy_preview_with-restore-data':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to preview with restore-data
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "preview.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/preview
          RESTORE_DATA: 'true'


###############################################################################


'deploy_test8':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to test8
  run_when: &RUN_ON_MASTER
    master branch:
      type: branch
      include_match: ^master$
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "test8.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/test8

'deploy_test8_with-db-drop':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to test8 with drop-database
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "test8.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/test8
          DROP_DATABASE: 'true'

###############################################################################


'deploy_test':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to test
  run_when: *RUN_ON_MASTER
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "test.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/test

'deploy_test_with-restore-data':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to test with restore-data
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "test.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/test
          RESTORE_DATA: 'true'

###############################################################################

'deploy_staging-v3-pdata':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to staging-v3-pdata
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "staging-v3-pdata.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/staging-v3-pdata

'deploy_staging-v3-pdata_with-restore-data':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to staging-v3-pdata with restore-data
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "staging-v3-pdata.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/staging-v3-pdata
          RESTORE_DATA: 'true'

###############################################################################

'deploy_staging-v3-upload':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to staging-v3-upload
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "staging-v3-upload.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/staging-v3-upload

'deploy_staging-v3-upload_with-db-drop':
  include: cider-ci/shared/deploy-job-defaults.yml
  name: Deploy to staging-v3-upload with drop-database
  context:
    tasks:
      deploy:
        exclusive_global_resources:
          "staging-v3-upload.madek.zhdk.ch": true
        environment_variables:
          HOSTS_FILE: inventories/zhdk/staging-v3-upload
          DROP_DATABASE: 'true'
