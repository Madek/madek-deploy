depends_on:
  build:
    type: job
    job_key: build
    states: [passed]

context:

  task_defaults:

    max_trials: 1

    aggregate_state: satisfy-last

    environment_variables:
      LANG: "en_US.UTF-8"
      DROP_DATABASE: 'false'
      RESTORE_DATA: 'false'

    traits:
      Ansible 2: yes
      ci-executor-madek: yes

    git_options:
      submodules:
        include_match: ^.*$

    scripts:
      deploy:
        timeout: 3 hours
        body: |
          set -eux
          cd deploy
          echo $(pwd)
          ls -R inventories
          time ansible-playbook -v -i "${HOSTS_FILE}" play_setup-and-deploy.yml \
             --extra-vars "{\"drop_database\": ${DROP_DATABASE}, \"restore_data\": ${RESTORE_DATA}}" \
             --vault-password-file inventories/zhdk/vault-pass

