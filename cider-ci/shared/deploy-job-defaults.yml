depends-on:
- type: job
  job: integration-tests
  states: [passed]

context:

  task-defaults:

    max-auto-trials: 1

    aggregate-state: satisfy-last

    environment-variables:
      LANG: "en_US.UTF-8"
      DROP_DATABASE: false
      RESTORE_DATA: false

    traits:
      ansible: true
      deploy-madek-test: true
      linux: true

    git-options:
      submodules:
        clone: true
        timeout: 60

    scripts:
      deploy:
        timeout: 5 hours
        body: |
          set -eux
          cd deploy
          echo $(pwd)
          ls -R inventories
          time ansible-playbook -v -i "${HOSTS_FILE}" play_setup-and-deploy.yml \
             --extra-vars "{\"drop_database\": ${DROP_DATABASE}, \"restore_data\": ${RESTORE_DATA}}" \
             --vault-password-file inventories/zhdk/vault-pass

